import{h as ce,aB as ne,r as C,s as k,j as e,A as p,T as x,q as N,B as T,R as le,a as c,d as n,e as l,b as d,f as r,P as de}from"./index-DR40DqkZ-1760117373439.js";import{T as me,a as oe,b as u,c as h}from"./tabs--XG1ap4n-1760117373439.js";import{u as xe}from"./useQuery-QLn7V3P3-1760117373439.js";import{u as ue}from"./useApiHealth-CgVWEbvt-1760117373439.js";import{C as m}from"./circle-check-big-Dm4BQvL5-1760117373439.js";import{C as i}from"./circle-x-ORXqys5p-1760117373439.js";import{D as he}from"./database-Cq82uGnx-1760117373439.js";import{Z as je}from"./zap-t9n5k4p1-1760117373439.js";import{T as W}from"./trending-up-ZJwkb9P4-1760117373439.js";import{G as fe}from"./globe-CcAoSMhb-1760117373439.js";import{C as Z}from"./clock-Dl-ApfhD-1760117373439.js";import{M as X}from"./minus-qAOnyWkr-1760117373439.js";import{T as pe}from"./trending-down-DD9ijQwJ-1760117373439.js";const He=()=>{var P,Q,A,q,F,U,I,z,O,M,$,E,G,K;const{toast:j}=ce(),J=ne(),{apiHealth:f,loading:S,checkApiHealth:B}=ue(),[g,Y]=C.useState([]),[v,_]=C.useState(null),{data:t,isLoading:D,error:R,refetch:ee}=xe({queryKey:["consolidated-health"],queryFn:async()=>{const{data:s,error:a}=await k.functions.invoke("unified-health-monitor");if(a)throw a;return s},refetchInterval:3e4});C.useEffect(()=>{w();const s=setInterval(w,2*60*1e3);return()=>clearInterval(s)},[]);const w=async()=>{try{const{data:s,error:a}=await k.functions.invoke("provider-quota-monitor");!a&&(s!=null&&s.success)&&Y(s.quotas||[]),_(new Date)}catch(s){console.error("Failed to fetch quota data:",s)}},se=async()=>{try{await Promise.all([ee(),w(),B()]),j({title:"Health Status Refreshed",description:"Latest provider health data has been loaded."})}catch{j({title:"Refresh Failed",description:"Failed to refresh health status. Please try again.",variant:"destructive"})}},te=async s=>{try{const{error:a}=await k.functions.invoke("provider-rotation",{body:{action:"reset-circuit-breaker",providerId:s}});if(a)throw a;j({title:"Circuit Breaker Reset",description:`Circuit breaker for ${s} has been reset.`}),J.invalidateQueries({queryKey:["consolidated-health"]})}catch{j({title:"Reset Failed",description:`Failed to reset circuit breaker for ${s}.`,variant:"destructive"})}},y=s=>{switch(s){case"healthy":return e.jsx(m,{className:"h-5 w-5 text-success"});case"degraded":return e.jsx(x,{className:"h-5 w-5 text-warning"});case"critical":case"outage":return e.jsx(i,{className:"h-5 w-5 text-destructive"});default:return e.jsx(Z,{className:"h-5 w-5 text-muted-foreground"})}},ae=s=>{switch(s){case"healthy":return"bg-success";case"degraded":return"bg-warning";case"critical":case"outage":return"bg-destructive";default:return"bg-muted"}},L=s=>{switch(s){case"healthy":return e.jsx(r,{variant:"default",children:"Healthy"});case"warning":case"degraded":return e.jsx(r,{variant:"secondary",children:"Warning"});case"critical":case"outage":return e.jsx(r,{variant:"destructive",children:"Critical"});default:return e.jsx(r,{variant:"outline",children:"Unknown"})}},re=s=>s.percentageUsed>=95?e.jsx(r,{variant:"destructive",children:"Critical"}):s.percentageUsed>=80?e.jsx(r,{variant:"secondary",children:"Warning"}):e.jsx(r,{variant:"default",children:"Healthy"}),ie=s=>{switch(s){case"closed":return e.jsx(m,{className:"h-4 w-4 text-success"});case"open":return e.jsx(i,{className:"h-4 w-4 text-destructive"});case"half-open":return e.jsx(x,{className:"h-4 w-4 text-warning"});default:return e.jsx(Z,{className:"h-4 w-4 text-muted-foreground"})}},H=s=>{switch(s){case"healthy":return e.jsx(W,{className:"h-4 w-4 text-success"});case"degraded":return e.jsx(X,{className:"h-4 w-4 text-warning"});case"critical":return e.jsx(pe,{className:"h-4 w-4 text-destructive"});default:return e.jsx(X,{className:"h-4 w-4 text-muted-foreground"})}},o=(t==null?void 0:t.overallStatus)||"unknown",b=((P=t==null?void 0:t.providers)==null?void 0:P.length)>0?Math.round(t.providers.reduce((s,a)=>s+a.responseTime,0)/t.providers.length):0;return D?e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):R?e.jsxs(p,{variant:"destructive",children:[e.jsx(x,{className:"h-4 w-4"}),e.jsxs(N,{children:["Failed to load health status: ",R.message]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"System Health Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Comprehensive provider health, quota, and performance monitoring"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Last updated: ",t?new Date(t.timestamp).toLocaleString():(v==null?void 0:v.toLocaleTimeString())||"Never"]}),e.jsxs(T,{variant:"outline",size:"sm",onClick:se,className:"gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),"Refresh"]})]})]}),e.jsxs(c,{children:[e.jsx(n,{children:e.jsxs(l,{className:"flex items-center gap-2",children:[y(o),"System Health Overview"]})}),e.jsx(d,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`w-16 h-16 mx-auto rounded-full flex items-center justify-center ${ae(o)}`,children:y(o)}),e.jsx("p",{className:"mt-2 font-semibold capitalize",children:o}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Overall Status"}),L(o)]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold",children:[((Q=t==null?void 0:t.summary)==null?void 0:Q.healthyProviders)||0," / ",((A=t==null?void 0:t.summary)==null?void 0:A.totalProviders)||0]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Services Online"}),H(o)]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold",children:[b,"ms"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Avg Response Time"}),H(b<1e3?"healthy":b<2e3?"degraded":"critical")]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:g.filter(s=>s.status==="critical").length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Critical Quotas"}),e.jsx(x,{className:"h-4 w-4 mx-auto text-warning"})]})]})})]}),(t==null?void 0:t.recommendations)&&t.recommendations.length>0&&e.jsxs(p,{children:[e.jsx(x,{className:"h-4 w-4"}),e.jsx(N,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Recommendations:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:t.recommendations.map((s,a)=>e.jsx("li",{className:"text-sm",children:s},a))})]})})]}),e.jsxs(me,{defaultValue:"providers",className:"space-y-4",children:[e.jsxs(oe,{className:"grid w-full grid-cols-5",children:[e.jsx(u,{value:"providers",children:"Providers"}),e.jsx(u,{value:"quotas",children:"Quotas"}),e.jsx(u,{value:"circuit-breakers",children:"Circuit Breakers"}),e.jsx(u,{value:"performance",children:"Performance"}),e.jsx(u,{value:"legacy",children:"Legacy Health"})]}),e.jsx(h,{value:"providers",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:((q=t==null?void 0:t.providers)==null?void 0:q.length)>0?t.providers.map(s=>{var a;return e.jsxs(c,{children:[e.jsx(n,{className:"pb-3",children:e.jsxs(l,{className:"flex items-center justify-between text-base",children:[e.jsx("span",{children:s.providerName}),y(s.status)]})}),e.jsxs(d,{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Status:"}),L(s.status)]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Response Time:"}),e.jsxs("span",{className:"text-sm font-mono",children:[s.responseTime,"ms"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Services:"}),e.jsx("div",{className:"flex gap-1",children:((a=s.serviceTypes)==null?void 0:a.map(V=>e.jsx(r,{variant:"outline",className:"text-xs",children:V},V)))||e.jsx(r,{variant:"outline",className:"text-xs",children:"Unknown"})})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Credentials:"}),s.credentialsValid?e.jsx(m,{className:"h-4 w-4 text-success"}):e.jsx(i,{className:"h-4 w-4 text-destructive"})]})]})]},s.providerId)}):e.jsx("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:"No provider data available"})})}),e.jsx(h,{value:"quotas",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:g.length>0?g.map((s,a)=>e.jsxs(c,{children:[e.jsx(n,{className:"pb-3",children:e.jsxs(l,{className:"flex items-center justify-between text-base",children:[e.jsx("span",{className:"capitalize",children:s.provider}),e.jsx(he,{className:"h-4 w-4"})]})}),e.jsxs(d,{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Quota Status:"}),re(s)]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Usage:"}),e.jsxs("span",{className:"text-sm font-mono",children:[s.percentageUsed.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Used / Limit:"}),e.jsxs("span",{className:"text-sm font-mono",children:[s.quotaUsed.toLocaleString()," / ",s.quotaLimit.toLocaleString()]})]}),e.jsx(de,{value:s.percentageUsed,className:"h-2"})]})]},a)):e.jsx("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:"No quota data available"})})}),e.jsx(h,{value:"circuit-breakers",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:((F=t==null?void 0:t.providers)==null?void 0:F.length)>0?t.providers.map(s=>e.jsxs(c,{children:[e.jsx(n,{className:"pb-3",children:e.jsxs(l,{className:"flex items-center justify-between text-base",children:[e.jsx("span",{children:s.providerName}),e.jsx(je,{className:"h-4 w-4"})]})}),e.jsxs(d,{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Circuit Breaker:"}),e.jsxs("div",{className:"flex items-center gap-2",children:[ie(s.circuitBreakerState),e.jsx("span",{className:"text-sm capitalize",children:s.circuitBreakerState})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm",children:"Failure Count:"}),e.jsx("span",{className:"text-sm font-mono",children:s.failureCount})]}),s.circuitBreakerState==="open"&&e.jsx(T,{size:"sm",variant:"outline",className:"w-full",onClick:()=>te(s.providerId),children:"Reset Circuit Breaker"})]})]},s.providerId)):e.jsx("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:"No circuit breaker data available"})})}),e.jsx(h,{value:"performance",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(c,{children:[e.jsx(n,{children:e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-5 w-5"}),"Response Time Analysis"]})}),e.jsx(d,{children:e.jsx("div",{className:"space-y-3",children:((U=t==null?void 0:t.providers)==null?void 0:U.length)>0?t.providers.map(s=>e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm",children:[s.providerName,":"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-20 bg-muted rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full ${s.responseTime>5e3?"bg-destructive":s.responseTime>2e3?"bg-warning":"bg-success"}`,style:{width:`${Math.min(s.responseTime/5e3*100,100)}%`}})}),e.jsxs("span",{className:"text-sm font-mono w-16 text-right",children:[s.responseTime,"ms"]})]})]},s.providerId)):e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"No performance data available"})})})]}),e.jsxs(c,{children:[e.jsx(n,{children:e.jsx(l,{children:"System Alerts"})}),e.jsx(d,{children:e.jsxs("div",{className:"space-y-2",children:[((z=(I=t==null?void 0:t.summary)==null?void 0:I.criticalQuotaProviders)==null?void 0:z.length)>0&&e.jsxs(p,{variant:"destructive",children:[e.jsx(x,{className:"h-4 w-4"}),e.jsxs(N,{children:["Critical quota: ",t.summary.criticalQuotaProviders.join(", ")]})]}),((M=(O=t==null?void 0:t.summary)==null?void 0:O.circuitBreakersOpen)==null?void 0:M.length)>0&&e.jsxs(p,{variant:"destructive",children:[e.jsx(i,{className:"h-4 w-4"}),e.jsxs(N,{children:["Circuit breakers open: ",t.summary.circuitBreakersOpen.join(", ")]})]}),!((E=($=t==null?void 0:t.summary)==null?void 0:$.criticalQuotaProviders)!=null&&E.length)&&!((K=(G=t==null?void 0:t.summary)==null?void 0:G.circuitBreakersOpen)!=null&&K.length)&&e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"No active alerts"})]})})]})]})}),e.jsx(h,{value:"legacy",children:e.jsxs(c,{children:[e.jsx(n,{children:e.jsxs(l,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5"}),"Legacy API Health Check"]})}),e.jsxs(d,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Activities"}),f.activities?e.jsx(m,{className:"h-5 w-5 text-success"}):e.jsx(i,{className:"h-5 w-5 text-destructive"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Hotels"}),f.hotels?e.jsx(m,{className:"h-5 w-5 text-success"}):e.jsx(i,{className:"h-5 w-5 text-destructive"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Flights"}),f.flights?e.jsx(m,{className:"h-5 w-5 text-success"}):e.jsx(i,{className:"h-5 w-5 text-destructive"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Transfers"}),f.transfers?e.jsx(m,{className:"h-5 w-5 text-success"}):e.jsx(i,{className:"h-5 w-5 text-destructive"})]})]}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx(T,{onClick:B,disabled:S,variant:"outline",size:"sm",children:S?"Checking...":"Refresh Legacy Checks"})})]})]})})]})]})};export{He as C};
