import{r as N,h as R,j as e,B as p,R as m,d,e as o,T as C,a as j,f as g,g as f,i as v,A as k,q as w,s as h}from"./index-WZ5873Kb-1761320647954.js";import{D as b}from"./database-Dyz1N2Xk-1761320647954.js";import{C as B}from"./circle-x-BOhHSa1d-1761320647954.js";import{S as P}from"./shield-CFtTHNb0-1761320647954.js";import{C as T}from"./credit-card-BG3x9F0P-1761320647954.js";import{C as A}from"./circle-check-big-BfnbplvO-1761320647954.js";const M=()=>{const[r,x]=N.useState({stuckBookings:0,criticalAlerts:0,providerHealth:"degraded",securityStatus:"vulnerable"}),[n,H]=N.useState({}),{toast:c}=R(),l=(t,s)=>{H(a=>({...a,[t]:s}))},E=async()=>{var t;l("cleanup",!0);try{const{data:s,error:a}=await h.functions.invoke("fix-stuck-bookings",{body:{automated:!1,timeoutMinutes:60}});if(a)throw a;const i=((t=s==null?void 0:s.recoveredBookings)==null?void 0:t.length)||0;x(u=>({...u,stuckBookings:Math.max(0,u.stuckBookings-i),lastCleanup:new Date().toISOString()})),c({title:"Cleanup Complete",description:`Successfully processed ${i} stuck bookings`,variant:"default"})}catch(s){c({title:"Cleanup Failed",description:s instanceof Error?s.message:"Unknown error",variant:"destructive"})}finally{l("cleanup",!1)}},D=async()=>{l("payment",!0);try{const{data:t,error:s}=await h.rpc("emergency_cleanup_payments");if(s)throw s;const a=t,i=(a==null?void 0:a.orphaned_payments_found)||0;c({title:"Payment Integrity Check Complete",description:`Found ${i} orphaned payments`,variant:i>0?"destructive":"default"})}catch(t){c({title:"Payment Check Failed",description:t instanceof Error?t.message:"Unknown error",variant:"destructive"})}finally{l("payment",!1)}},I=async()=>{var t;l("providers",!0);try{const{data:s,error:a}=await h.functions.invoke("critical-debug");if(a)throw a;const i=(t=s==null?void 0:s.tests)==null?void 0:t.every(u=>u.success);x(u=>({...u,providerHealth:i?"healthy":"degraded"})),c({title:"Provider Test Complete",description:i?"All providers healthy":"Some providers have issues",variant:i?"default":"destructive"})}catch{x(a=>({...a,providerHealth:"critical"})),c({title:"Provider Test Failed",description:"Critical provider connectivity issues detected",variant:"destructive"})}finally{l("providers",!1)}},S=async()=>{l("refresh",!0);try{const{count:t}=await h.from("bookings").select("*",{count:"exact",head:!0}).eq("status","pending").lt("created_at",new Date(Date.now()-36e5).toISOString()),{count:s}=await h.from("critical_alerts").select("*",{count:"exact",head:!0}).eq("resolved",!1).in("severity",["high","critical"]);x(a=>({...a,stuckBookings:t||0,criticalAlerts:s||0,securityStatus:"hardened"})),c({title:"Status Refreshed",description:"Emergency status updated successfully"})}catch{c({title:"Refresh Failed",description:"Could not update status",variant:"destructive"})}finally{l("refresh",!1)}},y=t=>{switch(t){case"healthy":case"secure":case"hardened":return"bg-success text-success-foreground";case"degraded":case"vulnerable":return"bg-warning text-warning-foreground";case"critical":return"bg-destructive text-destructive-foreground";default:return"bg-muted text-muted-foreground"}};return N.useEffect(()=>{S()},[]),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Emergency Stabilization"}),e.jsx("p",{className:"text-muted-foreground",children:"Critical system recovery and stabilization controls"})]}),e.jsxs(p,{onClick:S,disabled:n.refresh,variant:"outline",size:"sm",children:[n.refresh?e.jsx(m,{className:"w-4 h-4 animate-spin"}):e.jsx(m,{className:"w-4 h-4"}),"Refresh"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(d,{children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Stuck Bookings"}),e.jsx("p",{className:"text-2xl font-bold text-destructive",children:r.stuckBookings})]})]})})}),e.jsx(d,{children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Critical Alerts"}),e.jsx("p",{className:"text-2xl font-bold text-warning",children:r.criticalAlerts})]})]})})}),e.jsx(d,{children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Provider Health"}),e.jsx(j,{className:y(r.providerHealth),children:r.providerHealth})]})]})})}),e.jsx(d,{children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Security Status"}),e.jsx(j,{className:y(r.securityStatus),children:r.securityStatus})]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(d,{children:[e.jsxs(g,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5"}),"Booking Cleanup"]}),e.jsx(v,{children:"Clean up stuck bookings and resolve payment issues"})]}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(C,{className:"w-4 h-4"}),e.jsxs(w,{children:[r.stuckBookings," bookings require immediate attention"]})]}),e.jsxs(p,{onClick:E,disabled:n.cleanup,className:"w-full",variant:r.stuckBookings>0?"destructive":"default",children:[n.cleanup?e.jsx(m,{className:"w-4 h-4 animate-spin mr-2"}):null,"Run Emergency Cleanup"]})]})]}),e.jsxs(d,{children:[e.jsxs(g,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"w-5 h-5"}),"Payment Integrity"]}),e.jsx(v,{children:"Audit and fix orphaned payment intents"})]}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs(k,{children:[e.jsx(C,{className:"w-4 h-4"}),e.jsx(w,{children:"Check for orphaned Stripe payment intents"})]}),e.jsxs(p,{onClick:D,disabled:n.payment,className:"w-full",variant:"outline",children:[n.payment?e.jsx(m,{className:"w-4 h-4 animate-spin mr-2"}):null,"Check Payment Integrity"]})]})]}),e.jsxs(d,{children:[e.jsxs(g,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Provider Health"]}),e.jsx(v,{children:"Test API connectivity and credentials"})]}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs(j,{className:y(r.providerHealth),children:["Status: ",r.providerHealth]}),e.jsxs(p,{onClick:I,disabled:n.providers,className:"w-full",variant:"outline",children:[n.providers?e.jsx(m,{className:"w-4 h-4 animate-spin mr-2"}):null,"Test Connections"]})]})]})]}),e.jsxs(d,{children:[e.jsxs(g,{children:[e.jsxs(f,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"Security Status"]}),e.jsx(v,{children:"Security hardening implementation status"})]}),e.jsxs(o,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(A,{className:"w-5 h-5 text-success"}),e.jsx("span",{className:"font-medium",children:"Security hardening completed"}),e.jsx(j,{className:"bg-success text-success-foreground",children:"Secure"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsx("p",{children:"✅ Provider configuration tables secured with RLS"}),e.jsx("p",{children:"✅ API configuration access restricted to admins"}),e.jsx("p",{children:"✅ Provider quota information protected"}),e.jsx("p",{children:"✅ Emergency payment cleanup function deployed"})]})]})]}),r.lastCleanup&&e.jsxs(k,{children:[e.jsx(A,{className:"w-4 h-4"}),e.jsxs(w,{children:["Last cleanup completed: ",new Date(r.lastCleanup).toLocaleString()]})]})]})};export{M as EmergencyStabilization};
