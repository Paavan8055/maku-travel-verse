import{r as n,l as R,w as I,s as _}from"./index-Ds3Fyqjq-1761390734507.js";const B=()=>{const h=n.useCallback(({error:r,options:o={}})=>{const{context:g="application",showToast:C=!0,logError:m=!0,retryCallback:E}=o;m&&R.error(`[${g}] Error:`,r);const w=r instanceof Error?r:new Error(String(r)),y=d=>{const a=d.message.toLowerCase();if(a.includes("network")||a.includes("failed to fetch")||a.includes("connection"))return"Connection error. Please check your internet connection and try again.";if(a.includes("amadeus_auth_invalid_credentials")||a.includes("unauthorized"))return"Service temporarily unavailable. Our team has been notified.";if(a.includes("circuit breaker")||a.includes("rate limit")||a.includes("overload"))return"Service is temporarily busy. Please try again in a few minutes.";if(a.includes("missing required parameters")||a.includes("validation"))return"Please check your input and try again.";if(a.includes("check-in date cannot be in the past"))return"Please select a check-in date that is today or in the future.";if(a.includes("check-out date must be after check-in"))return"Please ensure your check-out date is after your check-in date.";if(a.includes("no hotels found")||a.includes("no flights found")||a.includes("no activities found"))return"No results found for your search criteria. Try adjusting your dates or location.";if(a.includes("payment")&&a.includes("failed"))return"Payment could not be processed. Please check your payment details and try again.";if(a.includes("booking")&&a.includes("failed"))return"Booking could not be completed. Please try again or contact support.";switch(g){case"hotel-search":return"Unable to search hotels at this time. Please try again.";case"flight-search":return"Unable to search flights at this time. Please try again.";case"activity-search":return"Unable to search activities at this time. Please try again.";case"booking":return"Unable to complete booking at this time. Please try again.";case"payment":return"Payment processing failed. Please try again.";default:return"Something went wrong. Please try again."}},p=d=>{const a=d.message.toLowerCase();return a.includes("amadeus_auth_invalid_credentials")||a.includes("circuit breaker")||a.includes("service unavailable")||a.includes("internal server error")},l=y(w),u=p(w);if(C){const d={duration:u?8e3:5e3,action:E&&u?{label:"Retry in 1 min",onClick:()=>{setTimeout(E,6e4)}}:void 0};I.error(l,d)}return{userMessage:l,isSystemError:u,originalError:w}},[]),v=n.useCallback((r,o)=>h({error:r,options:{context:"network",retryCallback:o}}),[h]),k=n.useCallback((r,o)=>{const g=o?`Please check the ${o} field and try again.`:"Please check your input and try again.";return I.error(g),R.warn("Validation error:",r),{userMessage:g,isSystemError:!1,originalError:r instanceof Error?r:new Error(String(r))}},[]),b=n.useCallback((r,o)=>h({error:r,options:{context:"booking",showToast:!0,logError:!0}}),[h]);return{handleError:h,handleNetworkError:v,handleValidationError:k,handleBookingError:b}},F=5,x=6e4,N=9e5,j=6,W=(h={})=>{const{checkInterval:v=30*60*1e3,enableAutoCheck:k=!0,onStatusChange:b}=h,[r,o]=n.useState(null),[g,C]=n.useState(!1),[m,E]=n.useState(null),[w,y]=n.useState(null),{handleError:p}=B(),l=n.useRef({failures:0,lastFailure:null,state:"closed"}),u=n.useRef([]),d=n.useRef(null),a=n.useCallback(()=>{const e=Date.now();return u.current=u.current.filter(t=>e-t<N),u.current.length>=j?(console.warn("Health check rate limited - backing off"),!0):(u.current.push(e),!1)},[]),T=n.useCallback(()=>{const e=l.current,t=Date.now();return e.state==="open"?e.lastFailure&&t-e.lastFailure>x?(e.state="half-open",!0):!1:!0},[]),D=n.useCallback(e=>{const t=l.current;t.failures=0,t.state="closed",d.current=e,localStorage.setItem("lastKnownHealth",JSON.stringify({data:e,timestamp:Date.now()})),o(e),y(null),E(new Date),b&&b(e)},[b]),H=n.useCallback(e=>{const t=l.current;t.failures++,t.lastFailure=Date.now(),t.failures>=F&&(t.state="open",console.warn("Health check circuit breaker opened due to repeated failures"));const c=localStorage.getItem("lastKnownHealth");if(c)try{const{data:s,timestamp:q}=JSON.parse(c);if(Date.now()-q<10*60*1e3){o({...s,status:"degraded"}),y("Using cached health data due to connection issues");return}}catch(s){console.warn("Failed to parse cached health data",s)}const i={status:"unhealthy",timestamp:Date.now(),services:{database:{status:"down",lastChecked:Date.now(),error:"Health check unavailable"},amadeus:{status:"down",lastChecked:Date.now(),error:"Health check unavailable"},stripe:{status:"down",lastChecked:Date.now(),error:"Health check unavailable"},supabase:{status:"down",lastChecked:Date.now(),error:"Health check unavailable"}},performance:{responseTime:0}};o(i),y((e==null?void 0:e.message)||"Health check system unavailable")},[]),f=n.useCallback(async()=>{var e;if(a())return console.warn("Health check skipped due to rate limiting"),d.current;if(!T())return console.warn("Health check skipped due to circuit breaker"),d.current;C(!0);try{const[t,c]=await Promise.allSettled([_.functions.invoke("health-check"),_.functions.invoke("provider-quota-monitor")]);if(t.status==="rejected"||t.value.error){const s=t.status==="rejected"?t.reason:t.value.error;return H(s),p({error:s,options:{context:"health-check",showToast:!1,logError:!0}}),null}const i=t.value.data;if(c.status==="fulfilled"&&((e=c.value.data)!=null&&e.success)){const s=c.value.data;i.quotaHealth={status:s.criticalProviders.length>0?"critical":s.warnings.length>0?"warning":"healthy",criticalProviders:s.criticalProviders.length,warnings:s.warnings.length,totalProviders:s.quotas.length,lastUpdated:Date.now()},s.criticalProviders.length>0&&i.status==="healthy"&&(i.status="degraded")}return D(i),i}catch(t){return H(t),p({error:t,options:{context:"health-check-network",showToast:!1,logError:!0}}),null}finally{C(!1)}},[p,a,T,D,H]),S=n.useCallback(()=>r?r.status:"unknown",[r]),P=n.useCallback(e=>r?r.services[e]:null,[r]),O=n.useCallback(e=>{const t=P(e);return(t==null?void 0:t.status)==="up"},[P]),L=n.useCallback(()=>{if(!r)return 0;const e=Object.values(r.services),t=e.filter(s=>s.status==="up").length,c=e.filter(s=>s.status==="slow").length,i=(t+c*.5)/e.length;return Math.round(i*100)},[r]),U=n.useCallback(async()=>await f(),[f]),M=n.useCallback(()=>{l.current={failures:0,lastFailure:null,state:"closed"},u.current=[],localStorage.removeItem("lastKnownHealth"),console.log("Circuit breaker and rate limiter reset")},[]);return n.useEffect(()=>{const e=localStorage.getItem("lastKnownHealth");if(e&&!r)try{const{data:t,timestamp:c}=JSON.parse(e);Date.now()-c<60*60*1e3&&(o({...t,status:"degraded"}),y("Showing cached health status"))}catch(t){console.warn("Failed to load cached health data",t)}},[r]),n.useEffect(()=>{if(!k)return;const e=setTimeout(()=>{f()},2e3),t=Math.random()*3e4,c=setInterval(f,v+t);return()=>{clearTimeout(e),clearInterval(c)}},[f,v,k]),n.useEffect(()=>{if(!k)return;const e=()=>{!document.hidden&&m&&Date.now()-m.getTime()>2*60*1e3&&f()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[f,k,m]),{health:r,loading:g,lastChecked:m,error:w,checkHealth:U,getOverallStatus:S,getServiceStatus:P,isServiceHealthy:O,getHealthScore:L,isHealthy:S()==="healthy",isDegraded:S()==="degraded",isUnhealthy:S()==="unhealthy",isCircuitBreakerOpen:l.current.state==="open",circuitBreakerState:l.current.state,resetCircuitBreaker:M}};export{W as u};
